<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parking Dashboard</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="Dashboard_style.css"> <!-- Custom CSS file -->

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.20.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.20.0/firebase-database-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            databaseURL: "https://parking-reservation-syst-631f1-default-rtdb.firebaseio.com"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        } else {
            firebase.app();
        }

        const dbRef = firebase.database().ref('parkingSpots');

        // Function to load reservations from Firebase
        function loadReservations(userId) {
            dbRef.child('reservations').orderByChild('userId').equalTo(userId).on('value', snapshot => {
                const reservations = snapshot.val();
                if (reservations) {
                    displayReservations(reservations);
                } else {
                    document.getElementById('reservationTableBody').innerHTML = "<tr><td colspan='7'>No reservations found.</td></tr>";
                }
            });
        }

        function displayReservations(reservations) {
            const reservationTableBody = document.getElementById('reservationTableBody');
            reservationTableBody.innerHTML = ""; // Clear any existing reservations

            for (const id in reservations) {
                const reservation = reservations[id];
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${reservation.car}</td>
                    <td>${reservation.licensePlate}</td>
                    <td>${new Date(reservation.date).toLocaleDateString()}</td>
                    <td>${reservation.parkingSpot}</td>
                    <td>${reservation.duration} minutes</td>
                    <td>${reservation.status}</td>
                    <td><button class="btn btn-danger btn-sm" onclick="cancelReservation('${id}')">Cancel</button></td>
                `;
                reservationTableBody.appendChild(row);
            }
        }

        // Function to make a reservation
        function reserveParking(event) {
            event.preventDefault();

            const userId = localStorage.getItem('userId');
            const car = document.getElementById('car').value;
            const licensePlate = document.getElementById('licensePlate').value;
            const date = document.getElementById('date').value;
            const parkingSpot = document.getElementById('parkingSpot').value;
            const duration = document.getElementById('duration').value;

            if (!userId || !car || !licensePlate || !date || !parkingSpot || !duration) {
                alert('Please fill all fields');
                return;
            }

            const reservationId = dbRef.child('reservations').push().key;
            const newReservation = {
                userId, car, licensePlate, date, parkingSpot, duration, status: 'Reserved'
            };

            dbRef.child(`reservations/${reservationId}`).set(newReservation)
                .then(() => {
                    alert('Parking spot reserved successfully');
                    loadReservations(userId);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert(`Failed to reserve parking spot: ${error.message}`);
                });
        }

        // Function to cancel a reservation
        function cancelReservation(reservationId) {
            dbRef.child(`reservations/${reservationId}`).remove()
                .then(() => {
                    alert("Reservation cancelled successfully.");
                    const userId = localStorage.getItem('userId');
                    loadReservations(userId);
                })
                .catch(error => {
                    console.error("Failed to cancel reservation:", error);
                });
        }

        // Function to update parking status on the page
        function updateParkingStatus(status) {
            const parkingStatusDiv = document.getElementById('parkingStatus');
            parkingStatusDiv.innerHTML = '';

            for (const [spot, availability] of Object.entries(status)) {
                const button = document.createElement('button');
                button.className = 'parking-spot ' + (availability.toLowerCase());
                button.innerText = `${spot}: ${availability}`;

                if (availability === 'Available') {
                    button.onclick = () => makeReservation(spot);
                } else {
                    button.disabled = true;
                }

                parkingStatusDiv.appendChild(button);
            }
        }

        // Listen for parking spot availability from Firebase
        dbRef.child('parkingStatus').on('value', snapshot => {
            const parkingStatus = snapshot.val();
            if (parkingStatus) {
                updateParkingStatus(parkingStatus);
            } else {
                document.getElementById('parkingStatus').innerText = 'No parking data available.';
            }
        });

        // Call initDashboard when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            const userId = localStorage.getItem('userId');
            initDashboard(userId);
        });

        // Initialize dashboard on page load
        function initDashboard(userId) {
            const userName = localStorage.getItem('userName'); // Retrieve user's name
            if (!userId) {
                alert('Please log in first');
                window.location.href = 'login.html';
                return;
            }
            document.getElementById('welcomeMessage').innerText = `Welcome, ${userName}`;
            loadReservations(userId);
        }
    </script>
</head>
<body>
    <div class="container">
        <div class="welcome-message text-center mt-4 mb-4" id="welcomeMessage"></div>

        <!-- Parking Spot Status -->
        <div class="parking-status-container text-center mb-4">
            <h2>Parking Spot Status</h2>
            <div id="parkingStatus">Waiting for updates...</div>
        </div>

        <!-- Reservation Form -->
        <div class="form-container">
            <h2>Reserve a Parking Spot</h2>
            <form id="reservationForm" onsubmit="reserveParking(event)">
                <div class="mb-3">
                    <label for="car" class="form-label">Car Model</label>
                    <input type="text" class="form-control" id="car" placeholder="Enter your car model" required>
                </div>
                <div class="mb-3">
                    <label for="licensePlate" class="form-label">Car License Plate</label>
                    <input type="text" class="form-control" id="licensePlate" placeholder="Enter your car's license plate" required>
                </div>
                <div class="mb-3">
                    <label for="date" class="form-label">Reservation Date</label>
                    <input type="date" class="form-control" id="date" required>
                </div>
                <div class="mb-3">
                    <label for="parkingSpot" class="form-label">Parking Spot</label>
                    <input type="text" class="form-control" id="parkingSpot" placeholder="Enter parking spot" required>
                </div>
                <div class="mb-3">
                    <label for="duration" class="form-label">Reservation Duration</label>
                    <select class="form-control" id="duration" required>
                        <option value="30">30 minutes</option>
                        <option value="120">2 hours</option>
                        <option value="240">4 hours</option>
                        <option value="720">12 hours</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Reserve Parking</button>
            </form>
        </div>

        <!-- Display list of reservations -->
        <div class="reservation-list mt-4">
            <h2>Your Reservations</h2>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Car</th>
                        <th>License Plate</th>
                        <th>Date</th>
                        <th>Parking Spot</th>
                        <th>Duration</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="reservationTableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
